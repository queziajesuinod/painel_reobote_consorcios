{% extends 'base.html' %}
{% block title %}Reobote Analytics{% endblock %}
{% block body_class %}analytics-body{% endblock %}
{% block navbar %}{% endblock %}
{% block main_class %} analytics-shell{% endblock %}
{% block extra_head %}
<style>
  .analytics-body {
    background-color: #2c2f33;
    color: #fff;
    min-height: 100vh;
    padding-top: 0;
  }

  .analytics-body footer {
    display: none;
  }

  .analytics-body .card {
    background-color: #2c2f33;
    border: none;
    color: #fff;
  }

  .carousel-wrapper {
    overflow: hidden;
    border-radius: 1rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
    min-height: clamp(280px, 38vw, 620px);
    height: 100%;
  }

  .carousel-inner,
  .carousel-item {
    min-height: 100%;
    height: 100%;
    display: flex;
    align-items: stretch;
  }

  .carousel-item img {
    width: 100%;
    height: auto;
    max-height: 100%;
    object-fit: cover;
  }

  .ultima-venda {
    text-align: center;
    gap: 0.5rem;
  }

  .profile-img {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid rgba(255, 255, 255, 0.35);
  }

  .ranking-container {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 15px;
    margin-top: 30px;
    padding: 0.2rem 0 0;
  }

  .ranking-item {
    border-radius: 1rem;
    padding: 12px 12px 18px;
    min-width: 140px;
    position: relative;
    text-align: center;
    flex: 0 0 auto;
    width: min(160px, 18vw);
    overflow: visible;
  }

  .ranking-item img:not(.coroa),
  .ranking-item .sem-foto {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 50%;
    border: 4px solid #ddd;
  }

  .ranking-item .sem-foto {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #ddd;
    color: #666;
    font-size: 0.85rem;
  }

  .ranking-item .nome {
    margin-top: 0.75rem;
    font-weight: 600;
    font-size: 1rem;
  }

  .ranking-item .total {
    color: #ccc;
    font-size: 0.9rem;
  }

  .ranking-item .coroa {
    width: 52px;
    height: 52px;
    padding: 4px;
    position: absolute;
    top: -32px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    border: none;
    background: transparent;
  }

  .ranking-card {
    overflow: visible;
    align-self: center;
    width: min(360px, 100%);
    padding-top: 2.25rem;
  }

  .analytics-columns {
    min-height: clamp(360px, 60vh, 520px);
  }

  .analytics-columns .col-lg-9,
  .analytics-columns .col-lg-3 {
    display: flex;
    flex-direction: column;
  }

  .analytics-columns .card:not(.ranking-card),
  .analytics-columns .carousel-wrapper {
    flex: 1;
  }

  @media (max-width: 992px) {
    .carousel-inner,
    .carousel-item {
      min-height: 300px;
    }

    .ranking-container {
      margin-top: 20px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0 py-4">
    <div class="row gx-0 gy-4 align-items-stretch analytics-columns">
        <div class="col-lg-8 d-flex flex-column h-100">
            <div class="carousel-wrapper">
                <div id="carouselExample" class="carousel slide h-100" data-bs-ride="carousel" data-bs-interval="10000">
                    <div class="carousel-inner h-100">
                        {% for p in propagandas %}
                        <div class="carousel-item {% if loop.index0 == 0 %}active{% endif %} h-100">
                            <img src="data:image/png;base64,{{ p.imagem_base64 }}" alt="{{ p.titulo }}"
                                class="d-block w-100 h-100">
                        </div>
                        {% endfor %}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExample"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-4 d-flex flex-column gap-3 h-100">
            <div class="card text-white h-100">
                <div class="card-body d-flex flex-column justify-content-between h-100">
                    <div>
                        <div class="row text-center">
                            <div class="col">
                                <h6>Vendas Anuais</h6>
                                <h6>R$ {{ vendas_anuais | format_valor }}</h6>
                            </div>
                            <div class="col">
                                <h6>Vendas Anuais Cotas</h6>
                                <h6>R$ {{ vendas_cotas | format_valor }}</h6>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col">
                                <h6>Vendas do Mês: {{ nome_mes }}</h6>
                                <h2>R$ {{ vendas_mes | format_valor }}</h2>
                            </div>
                        </div>
                        <hr class="border-light opacity-50">
                        <h6>Churrascômetro:</h6>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-{{ cor_churras }}" role="progressbar"
                                style="width: {{ porcentagem_churras }}%" aria-valuenow="{{ porcentagem_churras }}"
                                aria-valuemin="0" aria-valuemax="100">
                                {{ texto_churras }}
                            </div>
                        </div>
                        <h6>Última Venda:</h6>
                        {% if ultima_consultora %}
                        <div class="ultima-venda d-flex flex-column align-items-center mb-3">
                            <div class="d-flex align-items-center mb-3 gap-2">
                                {% if ultima_consultora.imagem_base64 %}
                                <img src="data:image/png;base64,{{ ultima_consultora.imagem_base64 }}"
                                    class="rounded-circle profile-img">
                                {% else %}
                                <img src="/static/reobot.png" class="rounded-circle profile-img">
                                {% endif %}
                                <div class="text-center">
                                    <p class="mb-0 fw-semibold">{{ ultima_consultora.nome }}</p>
                                    <small class="text-muted">{{ ultima_consultora.cidade }}</small>
                                </div>
                            </div>
                            <div class="text-center">
                                <small>Data de Fechamento: {{ ultima_consultora.data }}</small><br>
                                <strong class="h5">R$ {{ ultima_consultora.valor | format_valor }}</strong>
                            </div>
                        </div>
                        {% else %}
                        <p>Sem vendas este mês</p>
                        {% endif %}
                    </div>
                    <div class="mt-4">
                        <hr class="border-light opacity-50">
                        <div class="row text-center">
                            <div class="col-6">
                                <h6>Prospecção</h6>
                                <p class="display-6 mb-0">{{ prospeccao }}</p>
                            </div>
                            <div class="col-6">
                                <h6>Quentes</h6>
                                <p class="display-6 mb-0">{{ quentes }}</p>
                            </div>
                        </div>
                        {% if campanha_ativa %}
                        <hr class="border-light opacity-50">
                        <div>
                            <h6 class="text-center">Campanha {{ campanha_ativa.nome }}</h6>
                            <p class="text-center text-white-50 mb-1">
                                Meta: R$ {{ meta_campanha | format_valor }} &mdash; Atual: R$ {{ valor_atual |
                                format_valor }}
                            </p>
                            <div class="progress">
                                <div class="progress-bar bg-{{ cor_campanha }}" role="progressbar"
                                    style="width: {{ porcentagem_campanha }}%;" aria-valuenow="{{ porcentagem_campanha }}"
                                    aria-valuemin="0" aria-valuemax="100">
                                    {{ texto_campanha }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card p-34 ranking-card text-white">
                <h5 class="mb-0">Ranking de Empresas Parceiras</h5>
                <div class="ranking-container">
                    {% set ordem_podio = [1, 0, 2] %}
                    {% for i in ordem_podio %}
                    {% if ranking | length > i %}
                    {% set r = ranking[i] %}
                    <div class="ranking-item"
                        style="margin-bottom: {% if i == 0 %}30px{% elif i == 1 %}15px{% else %}0{% endif %};">
                        {% if i == 0 %}
                        <img src="{{ url_for('static', filename='coroa.png') }}" alt="Coroa"
                            class="coroa">
                        {% endif %}
                        {% if r.imagem_base64 %}
                        <img src="data:image/png;base64,{{ r.imagem_base64 }}" alt="Consultor">
                        {% else %}
                        <div class="sem-foto">
                            Sem foto
                        </div>
                        {% endif %}
                        <div class="nome">{{ r.nome }}</div>
                        <div class="total">R$ {{ r.total | format_valor }}</div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/fireworks.js') }}"></script>
<script>
  function dispararConfete() {
    if (confetti.isRunning()) return;
    confetti.start();
    setTimeout(() => confetti.stop(), 6000);
  }

  setInterval(async () => {
    const res = await fetch('/verificar-novas-vendas');
    const data = await res.json();
    if (data.temNovaVenda) {
      window.location.reload();
      const audios = ['silvio.mp3', 'silvio2.mp3', 'silvio3.mp3'];
      const audioSelecionado = audios[Math.floor(Math.random() * audios.length)];
      const audio = new Audio('/static/audios/' + audioSelecionado);
      audio.play();
      dispararConfete();
    }
  }, 5000);
</script>
{% endblock %}
